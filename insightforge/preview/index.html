<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InsightForge AI - Dynamic Industry Intelligence</title>
  <style>
    :root {
      --bg: #eef4ff;
      --surface: #ffffff;
      --ink: #0b1324;
      --muted: #425466;
      --line: #d9e2ef;
      --brand: #0b6bcb;
      --brand2: #0f766e;
      --warn: #b45309;
      --bad: #b42318;
      --good: #0a7d35;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top left, #dbeafe, #f8fbff 45%, #edf2ff);
      color: var(--ink);
    }
    .layout {
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      min-height: 100vh;
    }
    .sidebar {
      background: linear-gradient(165deg, #0b1324, #0b2844);
      color: #f8fbff;
      padding: 18px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: auto;
    }
    .sidebar h1 { margin: 0; font-size: 20px; }
    .sidebar p { margin: 8px 0 18px; color: #c8daef; font-size: 13px; }
    .field { margin-bottom: 12px; }
    .field label { display: block; font-size: 12px; margin-bottom: 6px; color: #cdddf2; }
    .field input, .field select, .field textarea {
      width: 100%;
      border: 1px solid #355172;
      background: #0f3358;
      color: #eff6ff;
      border-radius: 8px;
      padding: 9px;
      font-size: 13px;
    }
    .field textarea { resize: vertical; min-height: 72px; }
    .btn {
      width: 100%;
      border: none;
      background: linear-gradient(100deg, #0b6bcb, #0f766e);
      color: #fff;
      border-radius: 10px;
      padding: 11px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .main { padding: 20px; }
    .empty-state {
      background: #ffffff;
      border: 1px dashed #b7c9dd;
      border-radius: 12px;
      padding: 22px;
      color: #334155;
      box-shadow: 0 6px 18px rgba(11, 19, 36, .06);
    }
    .hero {
      background: linear-gradient(110deg, #0b6bcb, #0f766e);
      color: #fff;
      border-radius: 14px;
      padding: 18px;
    }
    .hero h2 { margin: 0; font-size: 28px; }
    .hero p { margin: 8px 0 0; color: #eaf5ff; }
    .grid { display: grid; gap: 14px; margin-top: 14px; }
    .g3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .g2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .g1 { grid-template-columns: 1fr; }
    .card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(11, 19, 36, .07);
    }
    .card h3 { margin: 0 0 10px; font-size: 15px; }
    .metric { font-size: 30px; font-weight: 700; letter-spacing: -0.02em; }
    .small { font-size: 12px; color: var(--muted); }
    .bar-row { margin-bottom: 10px; }
    .bar-meta { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .bar-wrap { height: 10px; background: #eef3fa; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; border-radius: 999px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border: 1px solid #e5eaf2; padding: 7px; vertical-align: top; }
    th { background: #f8fbff; text-align: left; }
    ul { margin: 8px 0 0 16px; padding: 0; }
    li { margin-bottom: 5px; }
    .pill { display: inline-block; padding: 3px 7px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .p-high { background: #ecfdf3; color: var(--good); }
    .p-med { background: #fff7ed; color: var(--warn); }
    .p-risk { background: #fef3f2; color: var(--bad); }
    .pair {
      display: grid;
      grid-template-columns: 1.25fr 1fr;
      gap: 12px;
      align-items: start;
    }
    .analysis {
      margin-top: 10px;
      background: #f6faff;
      border: 1px solid #d9e6f7;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      color: #20354f;
    }
    svg { width: 100%; height: auto; }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; }
      .g3, .g2, .pair { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h1>InsightForge AI</h1>
      <p>Dynamic Industry Intelligence Builder</p>
      <form id="controls">
        <div class="field">
          <label for="product">Product / Offering</label>
          <input id="product" value="Clinical AI Platform" />
        </div>
        <div class="field">
          <label for="industry">Industry</label>
          <input id="industry" value="AI in Healthcare" />
        </div>
        <div class="field">
          <label for="geo">Geo Focus</label>
          <select id="geo"></select>
        </div>
        <div class="field">
          <label for="horizon">Forecast Horizon</label>
          <input id="horizon" value="2024-2032" />
        </div>
        <div class="field">
          <label for="depth">Depth</label>
          <select id="depth">
            <option>Basic</option>
            <option>Professional</option>
            <option selected>Investor-grade</option>
          </select>
        </div>
        <div class="field">
          <label for="notes">Optional Strategic Notes</label>
          <textarea id="notes" placeholder="Add custom context, constraints, or angle."></textarea>
        </div>
        <button class="btn" type="submit">Generate Dynamic Report</button>
        <p id="statusText" class="small" style="color:#cdddf2; margin-top:10px;"></p>
      </form>
    </aside>

    <main class="main" id="report"></main>
  </div>

  <script>
    const GEO_DATA = {
      "Global": [],
      "North America": ["United States", "Canada", "Mexico", "Costa Rica", "Panama"],
      "Europe": ["Germany", "United Kingdom", "France", "Italy", "Spain"],
      "Asia Pacific": ["China", "India", "Japan", "South Korea", "Australia"],
      "Latin America": ["Brazil", "Argentina", "Chile", "Colombia", "Peru"],
      "Middle East & Africa": ["Saudi Arabia", "UAE", "South Africa", "Egypt", "Nigeria"]
    };

    const PALETTE = ["#0b6bcb", "#0f766e", "#9333ea", "#b45309", "#1d4ed8", "#db2777"];

    function hashSeed(text) {
      let h = 2166136261;
      for (let i = 0; i < text.length; i++) {
        h ^= text.charCodeAt(i);
        h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
      }
      return Math.abs(h >>> 0);
    }

    function seeded(seed) {
      const x = Math.sin(seed) * 10000;
      return x - Math.floor(x);
    }

    function normalizeShares(items, seed) {
      const raw = items.map((_, i) => 20 + Math.floor(seeded(seed + i * 17) * 60));
      const sum = raw.reduce((a, b) => a + b, 0);
      const shares = raw.map(v => Math.round((v / sum) * 100));
      const drift = 100 - shares.reduce((a, b) => a + b, 0);
      shares[0] += drift;
      return items.map((label, idx) => ({ label, share: shares[idx] }));
    }

    function buildGeoOptions() {
      const el = document.getElementById("geo");
      el.innerHTML = "";

      const globalOpt = document.createElement("option");
      globalOpt.value = "Global";
      globalOpt.textContent = "Global";
      el.appendChild(globalOpt);

      Object.keys(GEO_DATA).filter(r => r !== "Global").forEach(region => {
        const regionOpt = document.createElement("option");
        regionOpt.value = region;
        regionOpt.textContent = region + " (Region)";
        el.appendChild(regionOpt);

        GEO_DATA[region].forEach(country => {
          const cOpt = document.createElement("option");
          cOpt.value = country;
          cOpt.textContent = region + " - " + country;
          el.appendChild(cOpt);
        });
      });
      el.value = "Global";
    }

    function regionOf(geo) {
      if (geo === "Global") return "Global";
      if (GEO_DATA[geo]) return geo;
      for (const [region, countries] of Object.entries(GEO_DATA)) {
        if (countries.includes(geo)) return region;
      }
      return "Global";
    }

    function yearsFromHorizon(h) {
      const m = h.match(/(\d{4})\D+(\d{4})/);
      if (!m) return { start: 2024, end: 2032 };
      const start = parseInt(m[1], 10);
      const end = parseInt(m[2], 10);
      return { start, end: Math.max(end, start + 3) };
    }

    function fmt(n) { return Number(n).toFixed(1); }
    function deriveModelInputs(industry, geo, horizon) {
      const seed = hashSeed(industry + "|" + geo + "|" + horizon);
      const region = regionOf(geo);
      const regionFactor = {
        "Global": 1.22,
        "North America": 1.18,
        "Europe": 1.08,
        "Asia Pacific": 1.12,
        "Latin America": 0.88,
        "Middle East & Africa": 0.84
      }[region] || 1.0;
      const base = +(24 + seeded(seed + 5) * 78).toFixed(1) * regionFactor;
      const cagr = +(6.2 + seeded(seed + 9) * 8.6).toFixed(1);
      return { base: +base.toFixed(1), cagr };
    }

    function makeSyntheticVisuals(input) {
      const seed = hashSeed(input.product + input.industry + input.geo + input.horizon);
      const model = deriveModelInputs(input.industry, input.geo, input.horizon);
      const tokens = input.industry.split(/\s+/).map(t => t.trim()).filter(Boolean);
      const anchor = tokens[0] || "Industry";
      const geoShort = input.geo.replace(" (Region)", "");
      const companyPool = [
        `${anchor}Nova`, `${anchor}Axis`, `${anchor}Grid`, `${anchor}Logic`, `${anchor}Bridge`,
        `${anchor}Prime`, `${anchor}Works`, `${anchor}Dynamics`, `${anchor}Core`, `${anchor}Cloud`,
        `${geoShort} Ventures`, `${geoShort} Systems`, `${geoShort} Analytics`, `${geoShort} Labs`
      ];
      const rotatedCompanies = companyPool.slice(seed % companyPool.length).concat(companyPool.slice(0, seed % companyPool.length));
      const companyUniverse = rotatedCompanies.slice(0, 5);
      const segmentUniverse = {
        application: [`${anchor} Operations`, `${anchor} Intelligence`, `${anchor} Automation`, `${anchor} Experience`, `${anchor} Risk Controls`],
        type: [`${anchor} Platforms`, `${anchor} Services`, `${anchor} Infrastructure`, `${anchor} Managed Solutions`],
        endUse: [`${geoShort} Enterprises`, `${geoShort} Mid-Market`, `${geoShort} SMB`, `${geoShort} Public Sector`, `${geoShort} Channel`],
        category: [`${anchor} Premium`, `${anchor} Core`, `${anchor} Value`, `${anchor} Emerging`],
      };
      const yearsCfg = yearsFromHorizon(input.horizon);
      const years = Array.from({ length: yearsCfg.end - yearsCfg.start + 1 }, (_, i) => yearsCfg.start + i);
      const forecast = years.map((year, i) => ({
        year,
        market_size_usd_billion: +(model.base * Math.pow(1 + model.cagr / 100, i)).toFixed(2),
      }));
      const regional = regionOf(input.geo) === "Global"
        ? Object.keys(GEO_DATA).filter(r => r !== "Global").map((r, i) => ({
            region: r,
            share_percent: [33, 24, 27, 9, 7][i] || 5,
            summary: "Demand depth driven by digital maturity and policy structure.",
          }))
        : (GEO_DATA[regionOf(input.geo)] || [input.geo]).slice(0, 5).map((c, i) => ({
            region: c,
            share_percent: [34, 23, 19, 14, 10][i] || 8,
            summary: "Market growth linked to provider transformation and data infrastructure.",
          }));

      return {
        input_fingerprint: `${input.product} | ${input.industry} | ${input.geo} | ${input.horizon}`,
        current_market_size_usd_billion: model.base,
        cagr_percent: model.cagr,
        forecast_table: forecast,
        application_breakup: normalizeShares(segmentUniverse.application, seed + 22).map(x => ({ label: x.label, share_percent: x.share })),
        type_breakup: normalizeShares(segmentUniverse.type, seed + 44).map(x => ({ label: x.label, share_percent: x.share })),
        end_use_breakup: normalizeShares(segmentUniverse.endUse, seed + 66).map(x => ({ label: x.label, share_percent: x.share })),
        category_breakup: normalizeShares(segmentUniverse.category, seed + 88).map(x => ({ label: x.label, share_percent: x.share })),
        player_market_share: normalizeShares(companyUniverse, seed + 111).map(x => ({ label: x.label, share_percent: x.share })),
        market_dynamics: {
          trends: ["AI copilots move from pilot to scaled deployment", "Procurement shifts to ROI-linked contracts", "Governance-first adoption model expands"],
          drivers: ["Need for workflow automation", "Enterprise modernization spending", "Outcome-based vendor selection"],
          barriers: ["Integration complexity", "Compliance and audit overhead", "Model monitoring requirements"],
        },
        regional_overview: regional,
      };
    }

    function scenarioAssumptions(type, region) {
      if (type === "Pessimistic") {
        return [
          "Capital expenditure cycles remain delayed for 4-6 quarters.",
          "Policy uncertainty increases compliance costs by ~2-3% of revenue.",
          "Talent and data-integration bottlenecks limit scale deployment.",
          "Competitive pricing pressure reduces margin-backed reinvestment."
        ];
      }
      if (type === "Optimistic") {
        return [
          "Regulatory clarity and standards accelerate enterprise adoption.",
          "Platform interoperability lowers time-to-value for deployments.",
          "Public-private initiatives in " + region + " unlock new demand pools.",
          "High-value use-cases demonstrate measurable ROI within 12 months."
        ];
      }
      return [
        "Macro conditions stabilize with moderate enterprise tech spending growth.",
        "Adoption expands in priority verticals before broader rollout.",
        "Vendors balance innovation with responsible governance compliance.",
        "Channel partnerships improve distribution and implementation throughput."
      ];
    }

    function svgLine(series, opts = {}) {
      const width = 720, height = 290, pad = 40;
      const title = opts.title || "Market Size Trend";
      const xLabel = opts.xLabel || "Year";
      const yLabel = opts.yLabel || "USD Billion";
      const vals = series.map(s => s.value);
      const maxY = Math.max(...vals) * 1.08;
      const minY = Math.min(...vals) * 0.92;
      const span = Math.max(maxY - minY, 1);
      const pts = series.map((d, i) => {
        const x = pad + i * (width - 2 * pad) / Math.max(series.length - 1, 1);
        const y = height - pad - ((d.value - minY) / span) * (height - 2 * pad);
        return { x, y, year: d.year, value: d.value };
      });
      const poly = pts.map(p => `${p.x},${p.y}`).join(" ");
      return `
      <svg viewBox="0 0 ${width} ${height}" role="img" aria-label="market trend">
        <text x="${width / 2}" y="18" text-anchor="middle" font-size="13" fill="#1e293b">${title}</text>
        <line x1="${pad}" y1="${height - pad}" x2="${width - pad}" y2="${height - pad}" stroke="#a6b6ca"/>
        <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${height - pad}" stroke="#a6b6ca"/>
        <text x="${width / 2}" y="${height - 6}" text-anchor="middle" font-size="11" fill="#475569">${xLabel}</text>
        <text x="12" y="${height / 2}" text-anchor="middle" font-size="11" fill="#475569" transform="rotate(-90 12 ${height / 2})">${yLabel}</text>
        <polyline fill="none" stroke="#0b6bcb" stroke-width="3" points="${poly}"/>
        ${pts.map(p => `<circle cx="${p.x}" cy="${p.y}" r="3.8" fill="#0f766e"></circle><text x="${p.x}" y="${height - 12}" text-anchor="middle" font-size="10" fill="#334155">${p.year}</text>`).join("")}
      </svg>`;
    }

    function donutSegments(shares) {
      const radius = 78;
      const circumference = 2 * Math.PI * radius;
      let offset = 0;
      return shares.map((s, i) => {
        const arc = (s.share / 100) * circumference;
        const seg = `<circle r="${radius}" fill="none" stroke="${PALETTE[i % PALETTE.length]}" stroke-width="30" stroke-dasharray="${arc} ${circumference}" stroke-dashoffset="-${offset}" />`;
        offset += arc;
        return seg;
      }).join("");
    }

    function svgBars(data, valueKey, labelKey, valueSuffix = "", opts = {}) {
      const width = 520, barH = 24, gap = 12, pad = 40;
      const title = opts.title || "Distribution";
      const xLabel = opts.xLabel || "Value";
      const yLabel = opts.yLabel || "Categories";
      const items = (data || []).slice(0, 8);
      const height = pad * 2 + items.length * (barH + gap);
      const maxVal = Math.max(1, ...items.map(x => Number(x[valueKey] || 0)));
      return `
      <svg viewBox="0 0 ${width} ${height}" role="img" aria-label="bar chart">
        <text x="${width / 2}" y="18" text-anchor="middle" font-size="13" fill="#1e293b">${title}</text>
        <text x="${width / 2}" y="${height - 6}" text-anchor="middle" font-size="11" fill="#475569">${xLabel}</text>
        <text x="12" y="${height / 2}" text-anchor="middle" font-size="11" fill="#475569" transform="rotate(-90 12 ${height / 2})">${yLabel}</text>
        ${items.map((item, i) => {
          const y = pad + i * (barH + gap);
          const v = Number(item[valueKey] || 0);
          const w = Math.max(2, ((width - 230) * v) / maxVal);
          const label = String(item[labelKey] || "Segment");
          return `
            <text x="6" y="${y + 16}" font-size="11" fill="#334155">${label.slice(0, 28)}</text>
            <rect x="220" y="${y}" width="${w}" height="${barH}" fill="${PALETTE[i % PALETTE.length]}" rx="4"></rect>
            <text x="${220 + w + 6}" y="${y + 16}" font-size="11" fill="#334155">${fmt(v)}${valueSuffix}</text>
          `;
        }).join("")}
      </svg>`;
    }

    function svgTrendBars(dynamics) {
      const mapImpact = (x) => x === "High" ? 3 : 2;
      const rows = dynamics.map((d, i) => ({ label: `Trend ${i + 1}`, score: mapImpact(d.impact) }));
      return svgBars(rows, "score", "label", "", {
        title: "Trend Impact Score",
        xLabel: "Relative Impact Score",
        yLabel: "Trend Items"
      });
    }

    function svgScenarioLines(pessimistic, realistic, optimistic) {
      const width = 720, height = 300, pad = 40;
      const all = [...pessimistic, ...realistic, ...optimistic];
      const maxY = Math.max(...all.map(x => x.value)) * 1.08;
      const minY = Math.min(...all.map(x => x.value)) * 0.92;
      const span = Math.max(1, maxY - minY);
      const mapPts = (series) => series.map((d, i) => {
        const x = pad + i * (width - 2 * pad) / Math.max(series.length - 1, 1);
        const y = height - pad - ((d.value - minY) / span) * (height - 2 * pad);
        return { x, y, year: d.year };
      });
      const p1 = mapPts(pessimistic), p2 = mapPts(realistic), p3 = mapPts(optimistic);
      return `
      <svg viewBox="0 0 ${width} ${height}" role="img" aria-label="scenario line chart">
        <text x="${width / 2}" y="18" text-anchor="middle" font-size="13" fill="#1e293b">Scenario Forecast Comparison</text>
        <line x1="${pad}" y1="${height - pad}" x2="${width - pad}" y2="${height - pad}" stroke="#a6b6ca"/>
        <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${height - pad}" stroke="#a6b6ca"/>
        <text x="${width / 2}" y="${height - 6}" text-anchor="middle" font-size="11" fill="#475569">Year</text>
        <text x="12" y="${height / 2}" text-anchor="middle" font-size="11" fill="#475569" transform="rotate(-90 12 ${height / 2})">USD Billion</text>
        <polyline fill="none" stroke="#b45309" stroke-width="2.5" points="${p1.map(p => `${p.x},${p.y}`).join(" ")}"/>
        <polyline fill="none" stroke="#0b6bcb" stroke-width="2.5" points="${p2.map(p => `${p.x},${p.y}`).join(" ")}"/>
        <polyline fill="none" stroke="#0f766e" stroke-width="2.5" points="${p3.map(p => `${p.x},${p.y}`).join(" ")}"/>
        <text x="${width - 190}" y="30" font-size="11" fill="#b45309">Pessimistic</text>
        <text x="${width - 190}" y="48" font-size="11" fill="#0b6bcb">Realistic</text>
        <text x="${width - 190}" y="66" font-size="11" fill="#0f766e">Optimistic</text>
      </svg>`;
    }

    function wordCount(text) {
      return String(text || "").trim().split(/\s+/).filter(Boolean).length;
    }

    function fitWordRange(text, minWords, maxWords) {
      const fallback = "Execution discipline, governance maturity, and ecosystem alignment are required to convert strategic intent into measurable outcomes across commercial, operational, and compliance dimensions.";
      let out = String(text || "").trim();
      while (wordCount(out) < minWords) out += " " + fallback;
      const words = out.split(/\s+/);
      if (words.length > maxWords) out = words.slice(0, maxWords).join(" ");
      return out;
    }

    function buildSectionCommentary(title, input, region, seedOffset = 0) {
      const base = `
        ${title} for ${input.product} in ${input.industry} requires an execution view that combines adoption velocity, delivery readiness, and governance maturity. 
        In ${region}, buyers are prioritizing solutions that prove measurable operational value, reduce process friction, and integrate cleanly into existing workflows without introducing compliance instability. 
        The strongest programs align product packaging, implementation motion, and account strategy to buyer maturity bands rather than generic rollout assumptions. 
        Leadership teams should map dependencies across data quality, integration architecture, and policy interpretation so risks are surfaced early and mitigations are budgeted before scale commitments. 
        This section emphasizes practical decisions that improve conversion quality, shorten deployment cycles, and strengthen long-term defensibility.
      `;
      return fitWordRange(base, 100, 140);
    }

    function buildDetail3040(kind, topic, input, region) {
      const base = `
        ${kind} focus on ${topic} is intensifying in ${region} as ${input.industry} buyers demand faster measurable outcomes, stricter operational governance, and cleaner integration into existing workflows. 
        Teams that connect adoption milestones to accountable delivery metrics are outperforming peers on scale and retention.
      `;
      return fitWordRange(base, 30, 50);
    }

    function renderReport(input, livePayload) {
      const reportEl = document.getElementById("report");
      const seed = hashSeed(input.product + input.industry + input.geo + input.horizon);
      const region = regionOf(input.geo);
      const hasLiveVisuals = !!(livePayload && livePayload.visuals && Array.isArray(livePayload.visuals.forecast_table) && livePayload.visuals.forecast_table.length);
      const modeLabel = hasLiveVisuals ? "LIVE BACKEND DATA" : "MODELED FALLBACK DATA";
      const visuals = hasLiveVisuals ? livePayload.visuals : makeSyntheticVisuals(input);
      const currentBase = Number(visuals.current_market_size_usd_billion || 0);
      const realisticCagr = Number(visuals.cagr_percent || 0);
      const { start, end } = yearsFromHorizon(input.horizon);
      const years = Array.from({ length: end - start + 1 }, (_, i) => start + i);

      const realistic = (visuals.forecast_table || []).map((r) => ({ year: Number(r.year), value: Number(r.market_size_usd_billion) }));
      const pessimisticCagr = +(Math.max(realisticCagr - 3.8, 2.2)).toFixed(1);
      const optimisticCagr = +(realisticCagr + 3.6).toFixed(1);
      const forecastSeries = (base, cagr, yearList) => yearList.map((year, i) => ({ year, value: +(base * Math.pow(1 + cagr / 100, i)).toFixed(2) }));
      const pessimistic = forecastSeries(currentBase, pessimisticCagr, years);
      const optimistic = forecastSeries(currentBase, optimisticCagr, years);

      const normalizeLiveShares = (rows) =>
        (rows || []).map((x) => ({ label: x.label || x.region || "Segment", share: Number(x.share_percent || x.share || 0) }));

      const appBreak = normalizeLiveShares(visuals.application_breakup || normalizeShares([
        "Clinical Decision Support", "Workflow Automation", "Patient Engagement", "Risk & Compliance Analytics", "Revenue Cycle Intelligence"
      ], seed + 22));
      const typeBreak = normalizeLiveShares(visuals.type_breakup || []);
      const endUseBreak = normalizeLiveShares(visuals.end_use_breakup || normalizeShares([
        "Hospitals", "Payers", "Pharma", "Diagnostics", "Public Health"
      ], seed + 66));
      const categoryBreak = normalizeLiveShares(visuals.category_breakup || normalizeShares([
        "Enterprise", "Mid-Market", "SMB", "Government"
      ], seed + 88));
      const playerShare = normalizeLiveShares(visuals.player_market_share || []);

      const trendItems = (visuals.market_dynamics && visuals.market_dynamics.trends) || [];
      const driverItems = (visuals.market_dynamics && visuals.market_dynamics.drivers) || [];
      const barrierItems = (visuals.market_dynamics && visuals.market_dynamics.barriers) || [];
      const marketDynamics = [];
      const maxRows = Math.max(trendItems.length, 3);
      for (let i = 0; i < maxRows; i++) {
        const t = trendItems[i] || `Emerging trend ${i + 1} identified from source synthesis`;
        const d = driverItems[i] || "Demand-side momentum and enterprise investment support";
        const b = barrierItems[i] || "Execution complexity remains a limiting factor";
        marketDynamics.push({
          trend: t,
          highlight: d,
          impact: i === 0 ? "High" : "Medium",
          examples: b,
        });
      }

      const regionalRows = (visuals.regional_overview || []).length
        ? visuals.regional_overview.map((r) => ({
            region: r.region,
            share: Number(r.share_percent || 0),
            note: r.summary || "Market growth linked to provider transformation and data infrastructure.",
          }))
        : (region === "Global"
          ? Object.keys(GEO_DATA).filter(r => r !== "Global").map((r, i) => ({ region: r, share: [33, 24, 27, 9, 7][i] || 5, note: "Demand depth driven by digital maturity and policy structure." }))
          : (GEO_DATA[region] || [region]).slice(0, 5).map((c, i) => ({ region: c, share: [34, 23, 19, 14, 10][i] || 8, note: "Market growth linked to provider transformation and data infrastructure." })));

      const endYear = years[years.length - 1];
      const pessEnd = pessimistic[pessimistic.length - 1].value;
      const realEnd = realistic[realistic.length - 1].value;
      const optEnd = optimistic[optimistic.length - 1].value;

      const scenarioRows = [
        { name: "Pessimistic", cagr: pessimisticCagr, value: pessEnd, assumptions: scenarioAssumptions("Pessimistic", region) },
        { name: "Realistic", cagr: realisticCagr, value: realEnd, assumptions: scenarioAssumptions("Realistic", region) },
        { name: "Optimistic", cagr: optimisticCagr, value: optEnd, assumptions: scenarioAssumptions("Optimistic", region) }
      ];

      const majorTrendsDetailed = marketDynamics.slice(0, 4).map((row, i) => ({
        topic: row.trend,
        detail: buildDetail3040("Major trend", row.trend, input, region),
        score: 80 - i * 8
      }));
      const keyDriversDetailed = marketDynamics.slice(0, 4).map((row, i) => ({
        topic: row.highlight,
        detail: buildDetail3040("Key driver", row.highlight, input, region),
        score: 78 - i * 7
      }));
      const keyBarriersDetailed = marketDynamics.slice(0, 4).map((row, i) => ({
        topic: row.examples,
        detail: buildDetail3040("Key barrier", row.examples, input, region),
        score: 66 - i * 6
      }));
      const regulatoryOverviewDetailed = [
        {
          topic: `${region} compliance governance`,
          detail: buildDetail3040("Regulatory overview", `${region} compliance governance`, input, region),
          score: 74
        },
        {
          topic: "Auditability and model lifecycle controls",
          detail: buildDetail3040("Regulatory overview", "auditability and model lifecycle controls", input, region),
          score: 69
        },
        {
          topic: "Data residency and privacy safeguards",
          detail: buildDetail3040("Regulatory overview", "data residency and privacy safeguards", input, region),
          score: 64
        }
      ];

      const sectionInsights = {
        sizing: [
          `${input.product} in ${input.industry} shows compounding adoption with strongest acceleration in the second half of the horizon.`,
          `The realistic case is supported by delivery capacity and procurement cycles in ${region}.`,
          `Sensitivity remains highest to integration lead-times and compliance interpretation velocity.`
        ],
        segmentation: [
          `Segment concentration indicates where implementation resources should be prioritized in the next 12-18 months.`,
          `Lower-share segments represent expansion whitespace but require channel and service adaptation.`,
          `Portfolio strategy should align packaging with buyer maturity rather than one-size deployment.`
        ],
        dynamics: [
          `High-impact themes should be converted into quarterly execution milestones and account playbooks.`,
          `Barrier mitigation should be treated as a parallel workstream, not a post-sales activity.`,
          `Regulatory-readiness messaging is a differentiator in enterprise evaluations.`
        ],
        competitive: [
          `Top players retain share through ecosystem lock-in and faster implementation cycles.`,
          `Mid-tier entrants can win by vertical specialization and outcome-linked contracts.`,
          `Partnership architecture is now as important as raw model capability.`
        ],
        addendum: [
          `Build an enablement program across sales, compliance, and delivery to shorten time-to-value.`,
          `Adopt KPI instrumentation at deployment start: adoption depth, cycle-time reduction, and risk incidents.`,
          `Institutionalize governance with model QA gates, audit trails, and escalation standards.`
        ]
      };

      const list = arr => `<ul>${arr.map(x => `<li>${x}</li>`).join("")}</ul>`;
      const bars = (arr) => arr.map((x, i) => `
        <div class="bar-row">
          <div class="bar-meta"><span>${x.label}</span><span>${x.share}%</span></div>
          <div class="bar-wrap"><div class="bar" style="width:${x.share}%;background:${PALETTE[i % PALETTE.length]}"></div></div>
        </div>`).join("");

      reportEl.innerHTML = `
        <section class="hero">
          <h2>${input.product} - ${input.industry} Intelligence</h2>
          <p>${input.geo} | Forecast Horizon ${input.horizon} | Live API Analytical View</p>
          <p><span class="pill ${hasLiveVisuals ? "p-high" : "p-med"}">${modeLabel}</span></p>
          <p class="small" style="color:#eaf5ff;">Input Fingerprint: ${visuals.input_fingerprint || (input.product + " | " + input.industry + " | " + input.geo + " | " + input.horizon)}</p>
          <p class="small" style="color:#eaf5ff;">Generated at: ${new Date().toLocaleString()}</p>
          ${input.notes ? `<p><b>Custom angle:</b> ${input.notes}</p>` : ""}
        </section>

        <section class="grid g3">
          <article class="card"><h3>Current Market Size</h3><div class="metric">USD ${fmt(currentBase)}B</div><div class="small">Auto-modeled from industry + geography profile</div></article>
          <article class="card"><h3>Realistic Growth Rate</h3><div class="metric">${fmt(realisticCagr)}%</div><div class="small">Auto-modeled central CAGR</div></article>
          <article class="card"><h3>Forecast (${endYear})</h3><div class="metric">USD ${fmt(realEnd)}B</div><div class="small">Realistic scenario endpoint</div></article>
        </section>

        <section class="grid g2">
          <article class="card">
            <h3>Historical to Forecast Market Size (Realistic)</h3>
            ${svgLine(realistic, { title: "Historical to Forecast Market Size", xLabel: "Year", yLabel: "USD Billion" })}
            <div class="analysis">${buildSectionCommentary("Market Size Trajectory Commentary", input, region)}</div>
          </article>
          <article class="card">
            <h3>Market Share by Key Players</h3>
            <svg viewBox="0 0 300 220" aria-label="market share donut">
              <g transform="translate(150,110)">
                ${donutSegments(playerShare)}
                <text y="4" text-anchor="middle" font-size="13" fill="#0b1324">Top 5 Players</text>
              </g>
            </svg>
            <div class="small" style="margin-top:4px;"><b>Legend:</b> Colors map to players listed below in the same order.</div>
            ${bars(playerShare)}
            <div class="analysis">${buildSectionCommentary("Player Share Commentary", input, region)}</div>
          </article>
        </section>

        <section class="grid g2">
          <article class="card"><h3>Market Breakdown by Application</h3>${bars(appBreak)}<div class="analysis">${buildSectionCommentary("Application Sub-Segment Commentary", input, region)}</div></article>
          <article class="card"><h3>Market Breakdown by Type</h3>${bars(typeBreak)}<div class="analysis">${buildSectionCommentary("Product Type Sub-Segment Commentary", input, region)}</div></article>
        </section>
        <section class="card">
          <h3>Section Analysis: Market Structure</h3>
          <div class="analysis">${buildSectionCommentary("Market Structure Commentary", input, region)} ${list(sectionInsights.sizing)}</div>
        </section>

        <section class="grid g2">
          <article class="card"><h3>Market Breakdown by End-Use</h3>${bars(endUseBreak)}<div class="analysis">${buildSectionCommentary("End-Use Commentary", input, region)}</div></article>
          <article class="card"><h3>Market Breakdown by Category</h3>${bars(categoryBreak)}<div class="analysis">${buildSectionCommentary("Category Commentary", input, region)}</div></article>
        </section>
        <section class="card">
          <h3>Section Analysis: Segmentation</h3>
          <div class="analysis">${buildSectionCommentary("Segmentation Commentary", input, region)} ${list(sectionInsights.segmentation)}</div>
        </section>

        <section class="grid g1">
          <article class="card">
            <h3>Major Trends (Detailed 30-50 Words Each)</h3>
            <div class="pair">
              <div>
                <table>
                  <thead><tr><th>Major Trend</th><th>Detail (30-50 words)</th><th>Impact</th></tr></thead>
                  <tbody>
                    ${majorTrendsDetailed.map((d, i) => `<tr><td>${d.topic}</td><td>${d.detail}</td><td><span class="pill ${i === 0 ? "p-high" : "p-med"}">${i === 0 ? "High" : "Medium"}</span></td></tr>`).join("")}
                  </tbody>
                </table>
              </div>
              <div>${svgBars(majorTrendsDetailed, "score", "topic", "", { title: "Major Trends Impact", xLabel: "Impact Score", yLabel: "Trend" })}</div>
            </div>
            <div class="analysis">${buildSectionCommentary("Major Trends Commentary", input, region)}</div>
          </article>
        </section>

        <section class="grid g1">
          <article class="card">
            <h3>Key Drivers (Detailed 30-50 Words Each)</h3>
            <div class="pair">
              <div>
                <table>
                  <thead><tr><th>Key Driver</th><th>Detail (30-50 words)</th><th>Intensity</th></tr></thead>
                  <tbody>
                    ${keyDriversDetailed.map((d, i) => `<tr><td>${d.topic}</td><td>${d.detail}</td><td>${d.score}</td></tr>`).join("")}
                  </tbody>
                </table>
              </div>
              <div>${svgBars(keyDriversDetailed, "score", "topic", "", { title: "Key Drivers Intensity", xLabel: "Intensity Score", yLabel: "Driver" })}</div>
            </div>
            <div class="analysis">${buildSectionCommentary("Key Drivers Commentary", input, region)}</div>
          </article>
        </section>

        <section class="grid g1">
          <article class="card">
            <h3>Key Barriers (Detailed 30-50 Words Each)</h3>
            <div class="pair">
              <div>
                <table>
                  <thead><tr><th>Key Barrier</th><th>Detail (30-50 words)</th><th>Severity</th></tr></thead>
                  <tbody>
                    ${keyBarriersDetailed.map(d => `<tr><td>${d.topic}</td><td>${d.detail}</td><td>${d.score}</td></tr>`).join("")}
                  </tbody>
                </table>
              </div>
              <div>${svgBars(keyBarriersDetailed, "score", "topic", "", { title: "Key Barriers Severity", xLabel: "Severity Score", yLabel: "Barrier" })}</div>
            </div>
            <div class="analysis">${buildSectionCommentary("Key Barriers Commentary", input, region)}</div>
          </article>
        </section>

        <section class="grid g1">
          <article class="card">
            <h3>Regulatory Overview (Detailed 30-50 Words Each)</h3>
            <div class="pair">
              <div>
                <table>
                  <thead><tr><th>Regulatory Topic</th><th>Detail (30-50 words)</th><th>Priority</th></tr></thead>
                  <tbody>
                    ${regulatoryOverviewDetailed.map(d => `<tr><td>${d.topic}</td><td>${d.detail}</td><td>${d.score}</td></tr>`).join("")}
                  </tbody>
                </table>
              </div>
              <div>${svgBars(regulatoryOverviewDetailed, "score", "topic", "", { title: "Regulatory Priority", xLabel: "Priority Score", yLabel: "Regulatory Topic" })}</div>
            </div>
            <div class="analysis">${buildSectionCommentary("Regulatory Overview Commentary", input, region)}</div>
          </article>
        </section>

        <section class="grid g1">
          <article class="card">
            <h3>Regional / Country Overview</h3>
            <div class="pair">
              <div>
                <table>
                  <thead><tr><th>${region === "Global" ? "Region" : "Country"}</th><th>Share</th><th>Insight</th></tr></thead>
                  <tbody>
                    ${regionalRows.map(r => `<tr><td>${r.region}</td><td>${r.share}%</td><td>${r.note}</td></tr>`).join("")}
                  </tbody>
                </table>
              </div>
              <div>${svgBars(regionalRows, "share", "region", "%", { title: "Regional Share Distribution", xLabel: "Share (%)", yLabel: region === "Global" ? "Region" : "Country" })}</div>
            </div>
            <div class="analysis">${buildSectionCommentary("Regional Commentary", input, region)}</div>
          </article>
        </section>

        <section class="grid g1">
          <article class="card">
            <h3>Competitive Positioning</h3>
            <div class="pair">
              <div>
                <table>
                  <thead><tr><th>Company</th><th>Share</th><th>Positioning Insight</th></tr></thead>
                  <tbody>
                    ${playerShare.map(p => `<tr><td>${p.label}</td><td>${p.share}%</td><td>Defends share through delivery velocity, ecosystem strength, and enterprise trust.</td></tr>`).join("")}
                  </tbody>
                </table>
              </div>
              <div>${svgBars(playerShare, "share", "label", "%", { title: "Player Market Share", xLabel: "Share (%)", yLabel: "Company" })}</div>
            </div>
            <div class="analysis">${buildSectionCommentary("Competitive Commentary", input, region)} ${list(sectionInsights.competitive)}</div>
          </article>
        </section>

        <section class="grid g1">
          <article class="card">
            <h3>Scenario Table and Graph</h3>
            <div class="pair">
              <div>
                <table>
                  <thead><tr><th>Scenario</th><th>CAGR</th><th>${endYear} Value (USD Bn)</th><th>Assumptions</th></tr></thead>
                  <tbody>
                    ${scenarioRows.map(s => `<tr><td>${s.name}</td><td>${fmt(s.cagr)}%</td><td>${fmt(s.value)}</td><td>${s.assumptions.join("; ")}</td></tr>`).join("")}
                  </tbody>
                </table>
              </div>
              <div>${svgScenarioLines(pessimistic, realistic, optimistic)}</div>
            </div>
            <div class="analysis">${buildSectionCommentary("Scenario Commentary", input, region)}</div>
          </article>
        </section>

        <section class="card">
          <h3>Regulatory and Strategic Implications</h3>
          <ul>
            <li><b>Compliance burden:</b> Vendors with auditable AI governance and clear model lifecycle controls are likely to win enterprise deals faster.</li>
            <li><b>Localization pressure:</b> ${region} buyers increasingly prioritize local data-hosting, sovereign controls, and jurisdiction-ready compliance templates.</li>
            <li><b>Execution gap:</b> Winners will combine domain-specific applications with strong integration services and measurable business outcomes.</li>
          </ul>
          <div class="analysis">${buildSectionCommentary("Regulatory and Strategic Implications Commentary", input, region)} ${list(sectionInsights.dynamics)}</div>
        </section>

        <section class="card">
          <h3>Section Analysis: Competitive Outlook</h3>
          <div class="analysis">${buildSectionCommentary("Competitive Outlook Commentary", input, region)} ${list(sectionInsights.competitive)}</div>
        </section>

        <section class="card">
          <h3>Strategic Execution Addendum (Non-Market)</h3>
          <p class="small">This end section intentionally focuses on operating and execution priorities rather than additional market size or trend restatement.</p>
          <ul>
            <li><b>Operating Model Priorities:</b> define ownership for model risk, deployment QA, and post-go-live monitoring across product, compliance, and customer success.</li>
            <li><b>Capability Roadmap:</b> sequence core platform hardening, implementation accelerators, and verticalized templates for faster enterprise onboarding.</li>
            <li><b>Partnership Strategy:</b> deepen channel relationships with integrators and data ecosystem partners to reduce implementation friction.</li>
            <li><b>Execution Risks:</b> monitor backlog conversion, integration timelines, and policy shifts that can affect sales cycle length.</li>
            <li><b>KPI Framework:</b> track deployment cycle time, active-user depth, model quality drift, compliance exceptions, and realized customer ROI.</li>
          </ul>
          <div class="analysis">${buildSectionCommentary("Strategic Execution Addendum Commentary", input, region)} ${list(sectionInsights.addendum)}</div>
        </section>
      `;
    }

    buildGeoOptions();
    const form = document.getElementById("controls");
    const reportEl = document.getElementById("report");
    reportEl.innerHTML = `
      <section class="empty-state">
        <h3 style="margin-top:0;">Generate Dynamic Report</h3>
        <p>Select <b>Product / Offering</b>, <b>Industry</b>, <b>Geo Focus</b>, and horizon, then click <b>Generate Dynamic Report</b>.</p>
        <p style="margin-bottom:0;">The page will generate a full report from your selected inputs instantly, and if a backend is reachable it will refresh with live pipeline output.</p>
      </section>
    `;
    function resolveApiBases() {
      const out = [];
      out.push("http://127.0.0.1:8000");
      out.push("http://localhost:8000");
      if (window.location.protocol.startsWith("http") && ["localhost", "127.0.0.1"].includes(window.location.hostname)) {
        out.push(window.location.origin);
      }
      return [...new Set(out)];
    }

    async function requestWithFallback(path, options) {
      const bases = resolveApiBases();
      let lastErr = null;
      let lastStatus = null;
      for (const base of bases) {
        try {
          const resp = await fetch(`${base}${path}`, options);
          if (!resp.ok) {
            lastStatus = resp.status;
            continue;
          }
          return { resp, base };
        } catch (err) {
          lastErr = err;
        }
      }
      if (lastStatus && lastErr) {
        throw new Error(`Backend not reachable on localhost and non-backend origin returned status ${lastStatus}. Open this preview locally and ensure FastAPI runs on port 8000.`);
      }
      if (lastStatus) {
        throw new Error(`No backend accepted request (last status ${lastStatus}). Ensure FastAPI is running on http://127.0.0.1:8000.`);
      }
      throw lastErr || new Error("Unable to reach backend.");
    }

    async function createAndFetchLiveReport(input) {
      const statusText = document.getElementById("statusText");
      statusText.textContent = "Submitting exhaustive investor-grade research request...";

      const payload = {
        industry: input.notes ? `${input.product} for ${input.industry} (${input.notes})` : `${input.product} for ${input.industry}`,
        geography: input.geo,
        time_horizon: input.horizon,
        depth: "Investor-grade",
        include_financial_forecast: true,
        include_competitive_landscape: true
      };

      const createdReq = await requestWithFallback("/api/reports", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const createResp = createdReq.resp;
      const apiBase = createdReq.base;
      const created = await createResp.json();
      const reportId = created.id;

      for (let attempt = 0; attempt < 180; attempt++) {
        const statusResp = await fetch(`${apiBase}/api/reports/${reportId}/status`);
        if (!statusResp.ok) throw new Error(`Status check failed (${statusResp.status})`);
        const status = await statusResp.json();
        statusText.textContent = `Status: ${status.status} - ${status.message || ""}`;

        if (status.status === "Complete") {
          const reportResp = await fetch(`${apiBase}/api/reports/${reportId}`);
          if (!reportResp.ok) throw new Error(`Fetch report failed (${reportResp.status})`);
          return await reportResp.json();
        }
        if (status.status === "Failed") {
          throw new Error(status.message || "Report generation failed.");
        }
        await new Promise((resolve) => setTimeout(resolve, 3000));
      }
      throw new Error("Timed out waiting for report completion.");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = {
        product: document.getElementById("product").value.trim() || "Product",
        industry: document.getElementById("industry").value.trim() || "Industry",
        geo: document.getElementById("geo").value,
        horizon: document.getElementById("horizon").value.trim() || "2024-2032",
        depth: document.getElementById("depth").value,
        notes: document.getElementById("notes").value.trim()
      };
      const statusText = document.getElementById("statusText");
      statusText.textContent = "Generated from selected inputs (client-side). Trying live backend enrichment...";

      // Immediate dynamic generation from user-selected inputs.
      renderReport(input, { visuals: makeSyntheticVisuals(input) });

      try {
        const liveReport = await createAndFetchLiveReport(input);
        const visuals = (liveReport.metadata_json && liveReport.metadata_json.visuals) || {};
        renderReport(input, { visuals });
        statusText.textContent = "Live backend enrichment complete.";
      } catch (err) {
        const msg = err && err.message ? err.message : "Unable to fetch live report.";
        statusText.textContent = `Live backend unavailable: ${msg}. Showing input-driven generated report.`;
      }
    });
  </script>
</body>
</html>
